<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickAttend - QR Scan</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f0f4ff, #dce6ff);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      width: 400px;
      max-width: 95%;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      text-align: center;
    }
    h2 { margin-bottom: 15px; color: #2c3e50; }
    #reader { width: 100%; margin-top: 15px; display: none; }
    .btn {
      background: linear-gradient(45deg, #4a6cf7, #6f85f5);
      color: white; border: none; padding: 12px 20px;
      border-radius: 10px; cursor: pointer; font-size: 16px;
      margin-top: 10px; transition: 0.3s;
    }
    .btn:hover { background: linear-gradient(45deg, #3b5ad6, #5f73e0); }
    .date { margin-top: 20px; font-weight: bold; color: #444; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Scan QR to Mark Attendance</h2>
    <div id="reader"></div>
  </div>

<script>
  let scannerStarted = false;
  let html5QrcodeScanner;
  let rollno = null;

  window.onload = function () {
    const user = JSON.parse(sessionStorage.getItem("user"));
    if (user && user.data) {
      rollno = user.data.roll_number;
    }

    if (!scannerStarted) {
      document.getElementById("reader").style.display = "block";
      html5QrcodeScanner = new Html5Qrcode("reader");

      html5QrcodeScanner.start(
        { facingMode: "environment" }, // back camera
        { fps: 10, qrbox: 250 },
        async qrCodeMessage => {
          try {
            const qrData = JSON.parse(qrCodeMessage);
            const sessionId = qrData.session_id;
            const subjectName = qrData.subject;

            // call backend with helper
            const resp = await sendMarkAttendance(rollno, sessionId, "Present");

            if (resp.ok) {
              if (resp.already_marked) {
                showToast(`⚠️ Already marked for ${subjectName}`);
              } else {
                const todayDate = new Date().toISOString().split("T")[0];
                showToast(`✅ Attendance marked for ${subjectName} on ${todayDate}`);
              }
              // optional: stop scanner after one valid scan
              html5QrcodeScanner.stop();
            }
          } catch (e) {
            showToast("Invalid QR Code");
          }
        },
        errorMessage => {}
      );

      scannerStarted = true;
    }
  };

  async function sendMarkAttendance(roll_number, session_id, status = "Present") {
    try {
      const res = await fetch("http://127.0.0.1:5000/api/attendance/mark", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ roll_number, session_id, status })
      });

      const json = await res.json();

      if (!res.ok) {
        console.error("Server returned non-200:", res.status, json);
        showToast("Server error. Check console.");
        return { ok: false, reason: "server", payload: json };
      }

      if (json.ok) {
        if (json.already_marked) {
          return { ok: true, already_marked: true, payload: json };
        } else {
          return { ok: true, already_marked: false, payload: json };
        }
      } else {
        showToast(json.message || "Could not mark attendance");
        return { ok: false, reason: "application", payload: json };
      }

    } catch (err) {
      console.error("Network/Fetch error:", err);
      showToast("Network error. Try again.");
      return { ok: false, reason: "network", error: err };
    }
  }

  function showToast(msg) {
    alert(msg); // replace with a toast/snackbar if you have UI
  }
</script>
</body>
</html>
